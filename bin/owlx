#!/usr/bin/env bash
set -euo pipefail

# owlx - minimal tmux + git-worktree session runtime
#
# Assumptions (per user):
# 1) Layout: ~/projs/{main,fork,playground,archive}
# 2) Every project is a git repo (directory under a layout)
# 3) Repo-local .worktrees is ignored; 1 worktree <-> 1 session (MVP)
# 4) new requires: intent + category(fix/feat/refactor/research/chore) + worktree (run inside layout/repo)
# 5) ls shows: layout, repo, branch, intent(+cat)
# 6) tmux status line can show the same fields (see config snippet at bottom)

# ---- Config ----
# Load optional config file (shell-style assignments).
OXL_ROOT_ENV_SET=0
if [ "${OXL_ROOT+x}" = "x" ]; then
  OXL_ROOT_ENV_SET=1
  OXL_ROOT_ENV="$OXL_ROOT"
fi
OXL_WT_DIRNAME_ENV_SET=0
if [ "${OXL_WT_DIRNAME+x}" = "x" ]; then
  OXL_WT_DIRNAME_ENV_SET=1
  OXL_WT_DIRNAME_ENV="$OXL_WT_DIRNAME"
fi

if [ -f "$HOME/.owlxrc" ]; then
  # shellcheck source=/dev/null
  . "$HOME/.owlxrc"
fi

if [ "$OXL_ROOT_ENV_SET" -eq 1 ]; then
  OXL_ROOT="$OXL_ROOT_ENV"
fi
if [ "$OXL_WT_DIRNAME_ENV_SET" -eq 1 ]; then
  OXL_WT_DIRNAME="$OXL_WT_DIRNAME_ENV"
fi

OXL_ROOT="${OXL_ROOT:-$HOME/projs}"         # layout root
OXL_WT_DIRNAME="${OXL_WT_DIRNAME:-.worktrees}"
OXL_FLAG_KEY="@owlx"                         # meta-tag to mark owlx sessions
OXL_LAYOUT_KEY="@owlx_layout"
OXL_REPO_KEY="@owlx_repo"
OXL_REPO_DIR_KEY="@owlx_repo_dir"
OXL_WT_KEY="@owlx_worktree"
OXL_WT_DIR_KEY="@owlx_worktree_dir"
OXL_BRANCH_KEY="@owlx_branch"
OXL_CAT_KEY="@owlx_cat"
OXL_INTENT_KEY="@owlx_intent"
OXL_ID_KEY="@owlx_id"
OXL_PANEL_KEY="@owlx_panel_pane"
OXL_STATUS_KEY="@owlx_status_on"
OXL_STATUS_SAVED_KEY="@owlx_status_saved"
OXL_STATUS_FORMAT0_SAVED_KEY="@owlx_status_format0_saved"
OXL_STATUS_FORMAT1_SAVED_KEY="@owlx_status_format1_saved"
OXL_PANEL_WIDTH="${OXL_PANEL_WIDTH:-22}"
OXL_PANEL_ON_NEW="${OXL_PANEL_ON_NEW:-1}"
OXL_PANEL_INTERVAL="${OXL_PANEL_INTERVAL:-1}"
OXL_LEFT_PANE_BOTTOM_PCT="${OXL_LEFT_PANE_BOTTOM_PCT:-25}"
OXL_STATUS_ON_NEW="${OXL_STATUS_ON_NEW:-0}"
OXL_STATUS_LINES="${OXL_STATUS_LINES:-2}"
OXL_STATUS_RIGHT_LEN="${OXL_STATUS_RIGHT_LEN:-120}"
if [ -z "${OXL_STATUS_LEFT_FMT+x}" ]; then
  # Intent: fixed-width, scan-friendly fields on the owlx status line.
  OXL_STATUS_LEFT_FMT='#{?@owlx,#{p-10:#{=10:#{@owlx_layout}}} | #{p-8:#{=8:#{@owlx_cat}}} | #{p-20:#{=20:#{@owlx_repo}}} | #{p-20:#{=20:#{@owlx_branch}}},}'
fi
if [ -z "${OXL_STATUS_RIGHT_FMT+x}" ]; then
  # Intent: keep long intents bounded so the status line stays readable.
  OXL_STATUS_RIGHT_FMT="#{?@owlx,#{=${OXL_STATUS_RIGHT_LEN}:#{@owlx_intent}},}"
fi

OXL_BIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
OXL_HOME="$(cd "$OXL_BIN_DIR/.." && pwd)"
OXL_SELF="$OXL_BIN_DIR/$(basename "${BASH_SOURCE[0]}")"

die() { echo "owlx: $*" >&2; exit 1; }
require() { command -v "$1" >/dev/null 2>&1 || die "missing dependency: $1"; }

usage() {
  cat >&2 <<'EOF'
resume your intent â€” faster.

Usage:
  owlx new [--no-attach] [-C <layout/repo>] <category> <worktree> <intent...>
  owlx ls
  owlx search|s [--cd]
  owlx resume <session|id>
  owlx view <session|id>
  owlx del <session|id>
  owlx config [init|edit|tmux|gitignore|completion]
  owlx config completion [install|uninstall]
  owlx panel [on|off|toggle] [--session <session|id>] [--width <pct>]
  owlx status [on|off|toggle] [--session <session|id>]

Layouts:
  main | fork | playground | archive

Note:
  owlx new must be run from a repo under OXL_ROOT/<layout>/<repo> unless -C is provided

Search:
  owlx search        # print repo path (use: cd "$(owlx search)")
  owlx search --cd   # print shell cd command (use: eval "$(owlx search --cd)")
  # requires: fzf

Categories:
  fix | feat | refactor | research | chore

Env:
  OXL_ROOT=~/projs                (default)
  OXL_WT_DIRNAME=.worktrees       (default)
  OXL_PANEL_ON_NEW=1              (default; open panel on new)
  OXL_PANEL_WIDTH=22              (default; percent)
  OXL_PANEL_INTERVAL=1            (default; seconds)
  OXL_LEFT_PANE_BOTTOM_PCT=25     (default; left bottom pane percent)
  OXL_STATUS_ON_NEW=0             (default; show info in status line on new)
  OXL_STATUS_LINES=2              (default; status line rows when enabled)
  OXL_STATUS_RIGHT_LEN=120        (default; intent max length)
  ~/.owlxrc (optional, overrides defaults unless env is set)

Examples:
  cd ~/projs/main/coding-toolkit
  owlx new research feat-a "read docs and decide minimal MVP"
  owlx new --no-attach research feat-a "prep worktree only"
  owlx new -C main/coding-toolkit research feat-b "prep worktree only"
  cd "$(owlx search)"
  owlx ls
  owlx resume main/coding-toolkit/feat-a
  owlx view main/coding-toolkit/feat-a
  owlx del main/coding-toolkit/feat-a
  owlx config completion install
  owlx config completion uninstall
EOF
  exit 2
}

is_valid_layout() {
  case "$1" in main|fork|playground|archive) return 0 ;; *) return 1 ;; esac
}

is_valid_cat() {
  case "$1" in fix|feat|refactor|research|chore) return 0 ;; *) return 1 ;; esac
}

detect_repo_context() {
  local repo_dir root rel layout repo
  repo_dir="$(git -C "${PWD}" rev-parse --show-toplevel 2>/dev/null)" || \
    die "not inside a git repo"
  repo_dir="$(cd "$repo_dir" && pwd -P)"
  root="$(cd "$OXL_ROOT" 2>/dev/null && pwd -P)" || \
    die "missing OXL_ROOT directory: $OXL_ROOT"

  case "$repo_dir" in
    "$root"/*/*) rel="${repo_dir#"$root/"}" ;;
    *) die "repo must live under $root/<layout>/<repo>" ;;
  esac

  layout="${rel%%/*}"
  repo="${rel#*/}"
  if [ -z "$layout" ] || [ -z "$repo" ] || [[ "$repo" == *"/"* ]]; then
    die "repo must live under $root/<layout>/<repo>"
  fi

  is_valid_layout "$layout" || die "invalid layout: $layout"

  printf '%s\t%s\t%s\n' "$layout" "$repo" "$repo_dir"
}

parse_layout_repo() {
  local input="$1" root layout repo repo_dir
  case "$input" in
    */*) ;;
    *) die "-C expects <layout>/<repo>" ;;
  esac

  layout="${input%%/*}"
  repo="${input#*/}"
  if [ -z "$layout" ] || [ -z "$repo" ] || [[ "$repo" == *"/"* ]]; then
    die "-C expects <layout>/<repo>"
  fi
  is_valid_layout "$layout" || die "invalid layout: $layout"

  root="$(cd "$OXL_ROOT" 2>/dev/null && pwd -P)" || \
    die "missing OXL_ROOT directory: $OXL_ROOT"
  repo_dir="$root/$layout/$repo"
  if [ ! -d "$repo_dir" ]; then
    die "repo not found: $repo_dir"
  fi
  repo_dir="$(cd "$repo_dir" 2>/dev/null && pwd -P)" || \
    die "repo not found: $repo_dir"

  printf '%s\t%s\t%s\n' "$layout" "$repo" "$repo_dir"
}

repo_path() {
  local layout="$1" repo="$2"
  echo "$OXL_ROOT/$layout/$repo"
}

wt_path() {
  local repo_dir="$1" wt="$2"
  echo "$repo_dir/$OXL_WT_DIRNAME/$wt"
}

session_name() {
  local layout="$1" repo="$2" wt="$3"
  echo "$layout/$repo/$wt"
}

ensure_repo() {
  local repo_dir="$1"
  [ -d "$repo_dir" ] || die "repo not found: $repo_dir"
  git -C "$repo_dir" rev-parse --is-inside-work-tree >/dev/null 2>&1 || \
    die "not a git repo: $repo_dir"
}

ensure_worktrees_ignored_repo_local() {
  # Repo-local ignore: .git/info/exclude (won't touch global gitignore)
  local repo_dir="$1"
  mkdir -p "$repo_dir/.git/info"
  local excl="$repo_dir/.git/info/exclude"
  touch "$excl"
  if ! grep -qxF "$OXL_WT_DIRNAME/" "$excl"; then
    echo "$OXL_WT_DIRNAME/" >> "$excl"
  fi
}

tmux_get() {
  local sess="$1" key="$2"
  tmux show-option -t "$sess" -qv "$key" 2>/dev/null || true
}

tmux_set() {
  local sess="$1" key="$2" val="$3"
  tmux set-option -t "$sess" "$key" "$val"
}

gen_id() {
  local input="$1"
  if command -v sha1sum >/dev/null 2>&1; then
    printf '%s' "$input" | sha1sum | awk '{print substr($1,1,6)}'
  elif command -v shasum >/dev/null 2>&1; then
    printf '%s' "$input" | shasum | awk '{print substr($1,1,6)}'
  elif command -v md5sum >/dev/null 2>&1; then
    printf '%s' "$input" | md5sum | awk '{print substr($1,1,6)}'
  elif command -v md5 >/dev/null 2>&1; then
    printf '%s' "$input" | md5 | awk '{print substr($1,1,6)}'
  else
    printf '%s' "$input" | cksum | awk '{printf "%06d", $1 % 1000000}'
  fi
}

tsv_escape() {
  local s="$1"
  s=${s//$'\t'/ }
  s=${s//$'\n'/ }
  s=${s//$'\r'/ }
  printf '%s' "$s"
}

session_id() {
  local sess="$1"
  local id
  id="$(tmux_get "$sess" "$OXL_ID_KEY")"
  if [ -z "$id" ]; then
    id="$(gen_id "$sess")"
    tmux_set "$sess" "$OXL_ID_KEY" "$id"
  fi
  echo "$id"
}

resolve_session() {
  local token="$1"

  if tmux has-session -t "$token" 2>/dev/null; then
    echo "$token"
    return 0
  fi

  local sessions
  sessions="$(tmux ls -F '#S' 2>/dev/null || true)"
  [ -n "$sessions" ] || die "no such session or id: $token"

  local match="" count=0
  while read -r sess; do
    [ -n "$sess" ] || continue
    is_owlx_session "$sess" || continue
    if [ "$(session_id "$sess")" = "$token" ]; then
      match="$sess"
      count=$((count + 1))
    fi
  done <<< "$sessions"

  if [ "$count" -eq 1 ]; then
    echo "$match"
    return 0
  fi
  if [ "$count" -gt 1 ]; then
    die "ambiguous id: $token"
  fi
  die "no such session or id: $token"
}

setup_layout() {
  local sess="$1"
  local base_pane
  base_pane="$(tmux list-panes -t "$sess" -F '#{pane_id}' | head -n1)"
  [ -n "$base_pane" ] || return 0

  if [ "$OXL_STATUS_ON_NEW" = "1" ]; then
    status_on "$sess"
  fi

  if [ "$OXL_PANEL_ON_NEW" = "1" ] && [ "$OXL_STATUS_ON_NEW" != "1" ]; then
    if ! panel_pane_id "$sess"; then
      local panel_id
      panel_id="$(tmux split-window -h -p "$OXL_PANEL_WIDTH" -t "$base_pane" -P -F '#{pane_id}' \
        "$OXL_SELF" panel --loop "$sess")"
      tmux_set "$sess" "$OXL_PANEL_KEY" "$panel_id"
    fi
  fi

  tmux split-window -v -p "$OXL_LEFT_PANE_BOTTOM_PCT" -t "$base_pane"
  tmux select-pane -t "$base_pane"
}

panel_pane_id() {
  local sess="$1" id
  id="$(tmux_get "$sess" "$OXL_PANEL_KEY")"
  [ -n "$id" ] || return 1
  tmux list-panes -t "$sess" -F '#{pane_id}' | grep -qxF "$id"
}

status_is_on() {
  local sess="$1"
  [ "$(tmux_get "$sess" "$OXL_STATUS_KEY")" = "1" ]
}

status_on() {
  local sess="$1"
  status_is_on "$sess" && return 0

  # Intent: keep tmux default line intact, add owlx info on a second line.
  if panel_pane_id "$sess"; then
    local panel_id
    panel_id="$(tmux_get "$sess" "$OXL_PANEL_KEY")"
    tmux kill-pane -t "$panel_id" 2>/dev/null || true
    tmux set-option -t "$sess" -u "$OXL_PANEL_KEY" >/dev/null 2>&1 || true
  fi

  tmux_set "$sess" "$OXL_STATUS_SAVED_KEY" "$(tmux_get "$sess" status)"
  tmux_set "$sess" "$OXL_STATUS_FORMAT0_SAVED_KEY" "$(tmux_get "$sess" 'status-format[0]')"
  tmux_set "$sess" "$OXL_STATUS_FORMAT1_SAVED_KEY" "$(tmux_get "$sess" 'status-format[1]')"

  local line_fmt
  line_fmt="${OXL_STATUS_LINE_FMT:-#[align=left]${OXL_STATUS_LEFT_FMT}#[align=right]${OXL_STATUS_RIGHT_FMT}}"

  tmux set-option -t "$sess" status "$OXL_STATUS_LINES"
  if [ -z "$(tmux_get "$sess" 'status-format[0]')" ]; then
    local fmt0
    fmt0="$(tmux show-option -gqv 'status-format[0]')"
    if [ -n "$fmt0" ]; then
      tmux set-option -t "$sess" "status-format[0]" "$fmt0"
    fi
  fi
  tmux set-option -t "$sess" "status-format[1]" "$line_fmt"
  tmux_set "$sess" "$OXL_STATUS_KEY" "1"
}

status_off() {
  local sess="$1"
  status_is_on "$sess" || return 0

  local status_val format0 format1
  status_val="$(tmux_get "$sess" "$OXL_STATUS_SAVED_KEY")"
  format0="$(tmux_get "$sess" "$OXL_STATUS_FORMAT0_SAVED_KEY")"
  format1="$(tmux_get "$sess" "$OXL_STATUS_FORMAT1_SAVED_KEY")"

  if [ -n "$status_val" ]; then
    tmux set-option -t "$sess" status "$status_val"
  else
    tmux set-option -t "$sess" -u status >/dev/null 2>&1 || true
  fi

  if [ -n "$format1" ]; then
    tmux set-option -t "$sess" "status-format[1]" "$format1"
  else
    tmux set-option -t "$sess" -u "status-format[1]" >/dev/null 2>&1 || true
  fi

  if [ -n "$format0" ]; then
    tmux set-option -t "$sess" "status-format[0]" "$format0"
  else
    tmux set-option -t "$sess" -u "status-format[0]" >/dev/null 2>&1 || true
  fi

  tmux set-option -t "$sess" -u "$OXL_STATUS_KEY" >/dev/null 2>&1 || true
  tmux set-option -t "$sess" -u "$OXL_STATUS_SAVED_KEY" >/dev/null 2>&1 || true
  tmux set-option -t "$sess" -u "$OXL_STATUS_FORMAT0_SAVED_KEY" >/dev/null 2>&1 || true
  tmux set-option -t "$sess" -u "$OXL_STATUS_FORMAT1_SAVED_KEY" >/dev/null 2>&1 || true
}

panel_loop() {
  local sess="$1"
  local last_snapshot=""
  local -a last_lines=()
  local first=1
  session_id "$sess" >/dev/null
  while true; do
    tmux has-session -t "$sess" 2>/dev/null || exit 0
    local snapshot layout repo branch cat intent id
    snapshot="$(tmux display-message -p -t "$sess" \
      $'#{@owlx_layout}\t#{@owlx_repo}\t#{@owlx_branch}\t#{@owlx_cat}\t#{@owlx_intent}\t#{@owlx_id}')"
    if [ "$snapshot" != "$last_snapshot" ]; then
      IFS=$'\t' read -r layout repo branch cat intent id <<< "$snapshot"
      local -a lines=(
        "id:       $id"
        "layout:   $layout"
        "repo:     $repo"
        "branch:   $branch"
        "cat:      $cat"
        "intent:"
        "  $intent"
      )
      if [ "$first" -eq 1 ]; then
        printf '\033[H\033[J'
        for i in "${!lines[@]}"; do
          printf '\033[%d;1H\033[2K%s' "$((i+1))" "${lines[$i]}"
        done
        first=0
      else
        local i
        for i in "${!lines[@]}"; do
          if [ "${lines[$i]}" != "${last_lines[$i]-}" ]; then
            printf '\033[%d;1H\033[2K%s' "$((i+1))" "${lines[$i]}"
          fi
        done
        if [ "${#last_lines[@]}" -gt "${#lines[@]}" ]; then
          for ((i=${#lines[@]}; i<${#last_lines[@]}; i++)); do
            printf '\033[%d;1H\033[2K' "$((i+1))"
          done
        fi
      fi
      last_lines=("${lines[@]}")
      last_snapshot="$snapshot"
    fi
    sleep "$OXL_PANEL_INTERVAL"
  done
}

cmd_panel() {
  require tmux

  if [ "${1:-}" = "--loop" ]; then
    [ $# -eq 2 ] || die "panel loop requires a session name"
    panel_loop "$2"
    return 0
  fi

  local action="toggle"
  local target=""
  local width="$OXL_PANEL_WIDTH"

  while [ $# -gt 0 ]; do
    case "$1" in
      on|off|toggle) action="$1"; shift ;;
      --session)
        [ $# -ge 2 ] || die "--session requires <session|id>"
        target="$2"
        shift 2
        ;;
      --width) width="$2"; shift 2 ;;
      *) if [ -z "$target" ]; then target="$1"; else width="$1"; fi; shift ;;
    esac
  done

  if [ -z "$target" ]; then
    [ -n "${TMUX:-}" ] || die "session required (use: owlx panel --session <session|id>)"
    target="$(tmux display-message -p '#S')"
  fi

  local sess
  sess="$(resolve_session "$target")"

  if panel_pane_id "$sess"; then
    local id
    id="$(tmux_get "$sess" "$OXL_PANEL_KEY")"
    if [ "$action" = "on" ]; then
      return 0
    fi
    tmux kill-pane -t "$id" 2>/dev/null || true
    tmux set-option -t "$sess" -u "$OXL_PANEL_KEY" >/dev/null 2>&1 || true
    return 0
  fi

  if [ "$action" = "off" ]; then
    return 0
  fi

  local wt_dir
  wt_dir="$(tmux_get "$sess" "$OXL_WT_DIR_KEY")"
  local id
  id="$(tmux split-window -h -p "$width" -t "$sess" -c "$wt_dir" -P -F '#{pane_id}' \
    "$OXL_SELF" panel --loop "$sess")"
  tmux_set "$sess" "$OXL_PANEL_KEY" "$id"
}

cmd_status() {
  require tmux

  local action="toggle"
  local target=""

  while [ $# -gt 0 ]; do
    case "$1" in
      on|off|toggle) action="$1"; shift ;;
      --session)
        [ $# -ge 2 ] || die "--session requires <session|id>"
        target="$2"
        shift 2
        ;;
      *) if [ -z "$target" ]; then target="$1"; fi; shift ;;
    esac
  done

  if [ -z "$target" ]; then
    [ -n "${TMUX:-}" ] || die "session required (use: owlx status --session <session|id>)"
    target="$(tmux display-message -p '#S')"
  fi

  local sess
  sess="$(resolve_session "$target")"
  is_owlx_session "$sess" || die "refuse: not an owlx session: $sess"

  case "$action" in
    on) status_on "$sess" ;;
    off) status_off "$sess" ;;
    toggle)
      if status_is_on "$sess"; then
        status_off "$sess"
      else
        status_on "$sess"
      fi
      ;;
  esac
}

is_owlx_session() {
  local sess="$1"
  [ "$(tmux_get "$sess" "$OXL_FLAG_KEY")" = "1" ]
}

cmd_config() {
  local cfg="$HOME/.owlxrc"
  local sub="${1:-}"

  case "$sub" in
    "" )
      echo "config:    $cfg"
      echo "OXL_ROOT:  $OXL_ROOT"
      echo "OXL_WT_DIRNAME: $OXL_WT_DIRNAME"
      echo "OXL_STATUS_ON_NEW: $OXL_STATUS_ON_NEW"
      echo "OXL_STATUS_LINES: $OXL_STATUS_LINES"
      echo "OXL_STATUS_RIGHT_LEN: $OXL_STATUS_RIGHT_LEN"
      echo "precedence: env > config > defaults"
      return 0
      ;;
    init )
      if [ -e "$cfg" ]; then
        die "config already exists: $cfg"
      fi
      cat >"$cfg" <<'EOF'
# owlx config (shell-style assignments)
OXL_ROOT="$HOME/projs"
OXL_WT_DIRNAME=".worktrees"
EOF
      echo "created: $cfg"
      return 0
      ;;
    edit )
      "${EDITOR:-vi}" "$cfg"
      return 0
      ;;
    tmux )
      config_tmux "${2:-}"
      return 0
      ;;
    gitignore )
      config_gitignore "${2:-}"
      return 0
      ;;
    completion )
      config_completion "${2:-}"
      return 0
      ;;
    * )
      die "unknown config subcommand: $sub (use: owlx config [init|edit|tmux|gitignore|completion])"
      ;;
  esac
}

print_tmux_snippet() {
  cat <<'EOF'
# Adds a second status line (owlx sessions only), leaving line 1 untouched:
# line 2 left:  layout | cat | repo | branch (fixed widths)
# line 2 right: intent (trimmed to 120)
# set -g status 2
# set -g status-format[1] '#[align=left]#{?@owlx,#{p-10:#{=10:#{@owlx_layout}}} | #{p-8:#{=8:#{@owlx_cat}}} | #{p-20:#{=20:#{@owlx_repo}}} | #{p-20:#{=20:#{@owlx_branch}}},}#[align=right]#{?@owlx,#{=120:#{@owlx_intent}},}'
EOF
}

config_tmux() {
  local action="${1:-show}"
  local conf="$HOME/.tmux.conf"
  local start="# >>> owlx"
  local end="# <<< owlx"

  case "$action" in
    ""|show )
      print_tmux_snippet
      return 0
      ;;
    install )
      if [ -f "$conf" ] && grep -qF "$start" "$conf"; then
        die "tmux config already installed in: $conf"
      fi
      {
        echo "$start"
        print_tmux_snippet
        echo "$end"
      } >> "$conf"
      echo "installed tmux snippet in: $conf"
      return 0
      ;;
    * )
      die "unknown config tmux subcommand: $action (use: owlx config tmux [show|install])"
      ;;
  esac
}

print_gitignore_snippet() {
  cat <<'EOF'
.worktrees/
EOF
}

config_gitignore() {
  require git
  local action="${1:-show}"
  local conf
  conf="$(git config --global core.excludesfile 2>/dev/null || true)"
  if [ -z "$conf" ]; then
    conf="$HOME/.gitignore_global"
  fi

  case "$action" in
    ""|show )
      echo "global excludes: $conf"
      echo "line to add:"
      print_gitignore_snippet
      return 0
      ;;
    install )
      mkdir -p "$(dirname "$conf")"
      touch "$conf"
      if ! grep -qxF ".worktrees/" "$conf"; then
        echo ".worktrees/" >> "$conf"
      fi
      if [ -z "$(git config --global core.excludesfile 2>/dev/null || true)" ]; then
        git config --global core.excludesfile "$conf"
      fi
      echo "installed gitignore entry in: $conf"
      return 0
      ;;
    * )
      die "unknown config gitignore subcommand: $action (use: owlx config gitignore [show|install])"
      ;;
  esac
}

print_completion_snippet() {
  cat <<'EOF'
# >>> owlx completion
[ -r "$HOME/.bash_completion.d/owlx" ] && . "$HOME/.bash_completion.d/owlx"
# <<< owlx completion
EOF
}

config_completion() {
  local action="${1:-show}"
  local dest_dir="$HOME/.bash_completion.d"
  local dest="$dest_dir/owlx"
  local conf="$HOME/.bash_completion"
  local start="# >>> owlx completion"
  local end="# <<< owlx completion"
  local src="$OXL_HOME/completions/owlx.bash"

  case "$action" in
    ""|show )
      echo "completion file: $dest"
      echo "source file:     $src"
      echo "loader:          $conf"
      echo "snippet to load:"
      print_completion_snippet
      return 0
      ;;
    install )
      [ -f "$src" ] || die "missing completion source: $src"
      mkdir -p "$dest_dir"
      cp "$src" "$dest"
      if [ ! -f "$conf" ] || ! grep -qF "$start" "$conf"; then
        {
          echo ""
          print_completion_snippet
        } >> "$conf"
      fi
      echo "installed completion: $dest"
      echo "reload shell or: source $conf"
      return 0
      ;;
    uninstall )
      rm -f "$dest"
      if [ -f "$conf" ] && grep -qF "$start" "$conf"; then
        local tmp
        tmp="$(mktemp "${conf}.tmp.XXXX")"
        awk -v s="$start" -v e="$end" '
          $0 == s {skip=1; next}
          $0 == e {skip=0; next}
          !skip {print}
        ' "$conf" > "$tmp"
        mv "$tmp" "$conf"
      fi
      echo "removed completion: $dest"
      return 0
      ;;
    * )
      die "unknown config completion subcommand: $action (use: owlx config completion [install|uninstall])"
      ;;
  esac
}

cmd_search() {
  require fzf
  require git

  local root
  root="$(cd "$OXL_ROOT" 2>/dev/null && pwd -P)" || \
    die "missing OXL_ROOT directory: $OXL_ROOT"

  local selection
  selection="$(
    find "$root" -mindepth 2 -maxdepth 2 -type d 2>/dev/null | while read -r dir; do
      git -C "$dir" rev-parse --is-inside-work-tree >/dev/null 2>&1 || continue
      local rel layout
      rel="${dir#"$root/"}"
      layout="${rel%%/*}"
      is_valid_layout "$layout" || continue
      printf '%s\t%s\n' "$rel" "$dir"
    done | fzf --prompt='repo> ' --delimiter=$'\t' --with-nth=1 --exit-0
  )" || return 1

  [ -n "$selection" ] || return 1
  local path
  path="${selection#*$'\t'}"

  if [ "${1:-}" = "--cd" ]; then
    printf 'cd %q\n' "$path"
  else
    printf '%s\n' "$path"
  fi
}

cmd_new() {
  require git
  require tmux

  local attach=1
  local layout_repo=""
  while [ $# -gt 0 ]; do
    case "$1" in
      -d|--detached|--no-attach) attach=0; shift ;;
      -C)
        [ $# -ge 2 ] || die "-C requires <layout/repo>"
        layout_repo="$2"
        shift 2
        ;;
      --) shift; break ;;
      -*) die "unknown option: $1" ;;
      *) break ;;
    esac
  done

  [ $# -ge 3 ] || usage
  local cat="$1"; shift
  local wt="$1"; shift
  local intent="$*"

  is_valid_cat "$cat" || die "invalid category: $cat (use: fix|feat|refactor|research|chore)"
  [ -n "$intent" ] || die "intent must be non-empty"

  local layout repo repo_dir
  if [ -n "$layout_repo" ]; then
    IFS=$'\t' read -r layout repo repo_dir < <(parse_layout_repo "$layout_repo")
  else
    IFS=$'\t' read -r layout repo repo_dir < <(detect_repo_context)
  fi
  ensure_repo "$repo_dir"
  ensure_worktrees_ignored_repo_local "$repo_dir"

  local wt_dir; wt_dir="$(wt_path "$repo_dir" "$wt")"
  local sess; sess="$(session_name "$layout" "$repo" "$wt")"
  local branch="$wt"   # MVP: branch == worktree name

  # Safety: avoid name collision
  if tmux has-session -t "$sess" 2>/dev/null; then
    die "session already exists: $sess (use: owlx resume \"$sess\")"
  fi

  # Safety: avoid overwriting existing dir
  if [ -e "$wt_dir" ]; then
    die "worktree path already exists: $wt_dir"
  fi

  mkdir -p "$repo_dir/$OXL_WT_DIRNAME"

  # Create worktree + branch
  git -C "$repo_dir" worktree add -b "$branch" "$wt_dir" >/dev/null

  # Create tmux session in worktree
  tmux new-session -d -s "$sess" -c "$wt_dir"

  # Meta-tag: mark as owlx-created (critical)
  tmux_set "$sess" "$OXL_FLAG_KEY" "1"

  # Store metadata
  tmux_set "$sess" "$OXL_LAYOUT_KEY" "$layout"
  tmux_set "$sess" "$OXL_REPO_KEY" "$repo"
  tmux_set "$sess" "$OXL_REPO_DIR_KEY" "$repo_dir"
  tmux_set "$sess" "$OXL_WT_KEY" "$wt"
  tmux_set "$sess" "$OXL_WT_DIR_KEY" "$wt_dir"
  tmux_set "$sess" "$OXL_BRANCH_KEY" "$branch"
  tmux_set "$sess" "$OXL_CAT_KEY" "$cat"
  tmux_set "$sess" "$OXL_INTENT_KEY" "$intent"
  tmux_set "$sess" "$OXL_ID_KEY" "$(gen_id "$sess")"

  setup_layout "$sess"

  if [ "$attach" -eq 1 ]; then
    tmux attach -t "$sess"
  else
    echo "created: $sess"
  fi
}

cmd_resume() {
  require tmux
  [ $# -eq 1 ] || usage
  local sess
  sess="$(resolve_session "$1")"
  tmux attach -t "$sess"
}

cmd_view() {
  require tmux
  [ $# -eq 1 ] || usage
  local sess
  sess="$(resolve_session "$1")"

  echo "session:   $sess"
  echo "id:        $(session_id "$sess")"
  echo "owlx:      $(tmux_get "$sess" "$OXL_FLAG_KEY")"
  echo "layout:    $(tmux_get "$sess" "$OXL_LAYOUT_KEY")"
  echo "repo:      $(tmux_get "$sess" "$OXL_REPO_KEY")"
  echo "worktree:  $(tmux_get "$sess" "$OXL_WT_KEY")"
  echo "branch:    $(tmux_get "$sess" "$OXL_BRANCH_KEY")"
  echo "cat:       $(tmux_get "$sess" "$OXL_CAT_KEY")"
  echo "intent:    $(tmux_get "$sess" "$OXL_INTENT_KEY")"
  echo "repo_dir:  $(tmux_get "$sess" "$OXL_REPO_DIR_KEY")"
  echo "wt_dir:    $(tmux_get "$sess" "$OXL_WT_DIR_KEY")"
}

cmd_ls() {
  require tmux

  local sessions
  sessions="$(tmux ls -F '#S' 2>/dev/null || true)"
  [ -n "$sessions" ] || return 0

  local use_column=0
  command -v column >/dev/null 2>&1 && use_column=1

  if [ "$use_column" -eq 1 ]; then
    {
      printf "ID\tLAYOUT\tREPO\tBRANCH\tINTENT\n"
      printf "%s\t%s\t%s\t%s\t%s\n" "--" "------" "----" "------" "------"
      while read -r sess; do
        is_owlx_session "$sess" || continue

        local layout repo branch cat intent
        layout="$(tmux_get "$sess" "$OXL_LAYOUT_KEY")"
        repo="$(tmux_get "$sess" "$OXL_REPO_KEY")"
        branch="$(tmux_get "$sess" "$OXL_BRANCH_KEY")"
        cat="$(tmux_get "$sess" "$OXL_CAT_KEY")"
        intent="$(tmux_get "$sess" "$OXL_INTENT_KEY")"

        local id
        id="$(session_id "$sess")"

        printf "%s\t%s\t%s\t%s\t[%s] %s\n" \
          "$(tsv_escape "$id")" \
          "$(tsv_escape "$layout")" \
          "$(tsv_escape "$repo")" \
          "$(tsv_escape "$branch")" \
          "$(tsv_escape "$cat")" \
          "$(tsv_escape "$intent")"
      done <<< "$sessions"
    } | column -t -s $'\t'
  else
    printf "%-8s %-10s %-18s %-14s %s\n" "ID" "LAYOUT" "REPO" "BRANCH" "INTENT"
    printf "%-8s %-10s %-18s %-14s %s\n" "--" "------" "----" "------" "------"
    while read -r sess; do
      is_owlx_session "$sess" || continue

      local layout repo branch cat intent
      layout="$(tmux_get "$sess" "$OXL_LAYOUT_KEY")"
      repo="$(tmux_get "$sess" "$OXL_REPO_KEY")"
      branch="$(tmux_get "$sess" "$OXL_BRANCH_KEY")"
      cat="$(tmux_get "$sess" "$OXL_CAT_KEY")"
      intent="$(tmux_get "$sess" "$OXL_INTENT_KEY")"

      local id
      id="$(session_id "$sess")"

      printf "%-8s %-10s %-18s %-14s %s\n" \
        "$id" "$layout" "$repo" "$branch" "[$cat] $intent"
    done <<< "$sessions"
  fi
}

cmd_del() {
  require tmux
  require git
  [ $# -eq 1 ] || usage
  local sess
  sess="$(resolve_session "$1")"
  is_owlx_session "$sess" || die "refuse: not an owlx session: $sess"

  local repo_dir wt_dir
  repo_dir="$(tmux_get "$sess" "$OXL_REPO_DIR_KEY")"
  wt_dir="$(tmux_get "$sess" "$OXL_WT_DIR_KEY")"
  [ -n "$repo_dir" ] || die "missing repo_dir metadata for $sess"
  [ -n "$wt_dir" ] || die "missing worktree_dir metadata for $sess"

  # Kill tmux session first
  tmux kill-session -t "$sess" 2>/dev/null || true

  # Remove worktree directory registration (force)
  if [ -d "$wt_dir" ]; then
    git -C "$repo_dir" worktree remove "$wt_dir" -f >/dev/null || \
      die "failed to remove worktree: $wt_dir"
  fi

  echo "deleted: $sess"
}

main() {
  [ $# -ge 1 ] || usage
  local cmd="$1"; shift
  case "$cmd" in
    new)     cmd_new "$@" ;;
    ls)      cmd_ls "$@" ;;
    search|s) cmd_search "$@" ;;
    resume)  cmd_resume "$@" ;;
    view)    cmd_view "$@" ;;
    del)     cmd_del "$@" ;;
    config)  cmd_config "$@" ;;
    panel)   cmd_panel "$@" ;;
    status)  cmd_status "$@" ;;
    help|-h|--help) usage ;;
    *) die "unknown command: $cmd (use: owlx help)" ;;
  esac
}

main "$@"

# ---- tmux status line snippet (add to ~/.tmux.conf) ----
# Adds a second status line (owlx sessions only), leaving line 1 untouched:
# line 2 left:  layout | cat | repo | branch (fixed widths)
# line 2 right: intent (trimmed to 120)
#
# set -g status 2
# set -g status-format[1] '#[align=left]#{?@owlx,#{p-10:#{=10:#{@owlx_layout}}} | #{p-8:#{=8:#{@owlx_cat}}} | #{p-20:#{=20:#{@owlx_repo}}} | #{p-20:#{=20:#{@owlx_branch}}},}#[align=right]#{?@owlx,#{=120:#{@owlx_intent}},}'
